"use strict";var Ns=Object.create;var ge=Object.defineProperty;var Bs=Object.getOwnPropertyDescriptor;var Ds=Object.getOwnPropertyNames;var vs=Object.getPrototypeOf,Ms=Object.prototype.hasOwnProperty;var R=(e,t)=>()=>(e&&(t=e(e=0)),t);var Me=(e,t)=>{for(var r in t)ge(e,r,{get:t[r],enumerable:!0})},ft=(e,t,r,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of Ds(t))!Ms.call(e,n)&&n!==r&&ge(e,n,{get:()=>t[n],enumerable:!(s=Bs(t,n))||s.enumerable});return e};var m=(e,t,r)=>(r=e!=null?Ns(vs(e)):{},ft(t||!e||!e.__esModule?ge(r,"default",{value:e,enumerable:!0}):r,e)),Fs=e=>ft(ge({},"__esModule",{value:!0}),e);var o=R(()=>{});var Et,Fe,ht=R(()=>{"use strict";o();Et=require("nanoid"),Fe=(0,Et.customAlphabet)("abcdefghijklmnopqrstuvwxyz",10)});function Rt(){return Tt}function It(e){Tt.push(e)}var Tt,ke=R(()=>{"use strict";o();Tt=[]});var A,$,je,M,g,S,fe,K,He,Uo,Ao,Po,xo,bo,Ee,Ct,C,_t=R(()=>{"use strict";o();A=m(require("chalk")),$=m(require("util"));_();ke();je=(...e)=>{let t=$.default.format(...e);It(t),console.log(t)},M=je,g=(...e)=>(d("WARNING: ",$.default.format(...e)),je(A.default.bgYellow.black(" WARNING "),$.default.format(...e))),S=(...e)=>je(A.default.bgRed.white(" ERROR "),$.default.format(...e)),fe=(...e)=>M(A.default.blue.bold($.default.format(...e))),K=()=>console.log(`
`+A.default.dim(Array(48).fill("=").join(""))+`
`),He=(e=2)=>console.log(Array(e).fill("").join(`
`)),Uo=A.default.cyan,Ao=A.default.blueBright,Po=A.default.red,xo=A.default.green,bo=A.default.gray,Ee=A.default.white,Ct=A.default.magenta,C=A.default.dim});var P=R(()=>{"use strict";o();ke();_t()});function ks(e,t){return he({path:e,name:null,uploadUrl:t,contentType:"text/plain"},"text/plain",void 0)}async function he(e,t,r){let s=await Ut.default.readFile(e.path);return At("Uploading file %s",e.uploadUrl,{buffer:Buffer.byteLength(s)}),Pt(s,e.uploadUrl,t,r)}async function Ve(e,t,r){return At("Uploading buffer %s",e.name,{buffer:Buffer.byteLength(e.buffer)}),Pt(e.buffer,e.uploadUrl,t,r)}async function js(e,t,r,s){return(0,yt.default)({method:"put",url:t,data:e,onUploadProgress:s,headers:{"Content-Disposition":"inline","Content-Type":r}})}async function Pt(...e){await(0,St.default)(async()=>{await js(...e)},{retries:5,onRetry:(t,r)=>{if(r===5){S(`Cannot upload after ${r} times: ${t.message}`);return}g(`Upload failed ${r} out of 5 attempts: ${t.message}`)}})}var St,yt,Ut,At,Ge,We=R(()=>{"use strict";o();St=m(require("async-retry")),yt=m(require("axios")),Ut=m(require("fs/promises"));_();P();At=d.extend("upload"),Ge=(n=>(n.PNG="image/png",n.WEBM="video/webm",n.TEXT="text/plain",n.ZIP="application/zip",n))(Ge||{})});var bt,xt=R(()=>{bt={name:"@currents/playwright",version:"0.11.5",main:"./dist/index.js",author:"Currents Software Inc",license:"GPL-3.0-or-later",scripts:{test:"jest",rm:"rimraf dist",lint:'TIMING=1 eslint "**/*.ts*"',build:"tsup-node --minify --dts",dev:"tsup-node --watch --dts",release:"release-it ","publish:npm":"npm run rm  && npm run build && ./publish.js","release-ci":"npm run rm && npm run build && ./publish.js -t latest"},bin:{pwc:"./dist/bin/index.js"},devDependencies:{"@playwright/test":"1.40.0","@release-it/conventional-changelog":"^7.0.2","@swc/jest":"^0.2.24","@types/async-retry":"^1.4.5","@types/babel__code-frame":"^7.0.3","@types/debug":"^4.1.11","@types/getos":"^3.0.1","@types/jest":"^29.5.3","@types/json-stringify-safe":"^5.0.0","@types/lodash":"^4.14.191","@types/pluralize":"^0.0.33","@types/randomstring":"^1.1.8","@types/shelljs":"^0.8.11","@types/stack-utils":"^2.0.1",eslint:"^7.32.0","eslint-config-custom":"*",jest:"^29.5.0",msw:"^1.2.3","release-it":"^16.2.1",rimraf:"^4.1.1",tsconfig:"*",tsup:"^6.5.0",typescript:"^4.5.2",wtfnode:"^0.9.1"},dependencies:{"@babel/code-frame":"^7.18.6","@commander-js/extra-typings":"^11.1.0","@currents/commit-info":"file:./@currents/commit-info","@currents/pwc-parser":"*","@currents/pwc-scanner":"*","async-retry":"^1.3.3",axios:"^1.2.0","axios-retry":"^3.4.0",chalk:"^4.1.2",colors:"^1.4.0",commander:"^11.1.0","date-fns":"^2.29.3",debug:"^4.3.4",dotenv:"^16.0.3",execa:"^7.2.0",getos:"^3.2.1","image-size":"^1.0.2","json-stringify-safe":"^5.0.1",lodash:"^4.17.21",nanoid:"^3.3.4","p-all":"^3.0.0",pino:"^8.11.0",pluralize:"^8.0.0","pretty-ms":"^7.0.1",randomstring:"^1.2.3","source-map-support":"^0.5.21","stack-utils":"^2.0.6","tmp-promise":"^3.0.3","ts-pattern":"^4.3.0"},files:["dist","!**/*.map","!**/*/*.map","**/*.LEGAL.txt","LICENSE.md","README.md","CHANGELOG.md"],keywords:["playwright","playwright dashboard","cloud dashboard","reporter","currents","tests reporter","sorry cypress","ci"],exports:{".":{import:"./dist/index.js",require:"./dist/index.js"},"./parallel":{import:"./dist/parallel/index.js",require:"./dist/parallel/index.js"},"./package.json":"./package.json"},publishConfig:{access:"public",registry:"https://registry.npmjs.org"},"release-it":{npm:{publish:!1},github:{release:!0},plugins:{"@release-it/conventional-changelog":{preset:"angular",header:"# Changelog",ignoreVersion:!0,infile:"../../CHANGELOG.md"}},git:{commitMessage:"chore: release v${version}",tagName:"v${version}"}}}});var Ot,Lt=R(()=>{"use strict";o();xt();Ot=bt.version});function Nt(){Te.addListener("runCancelled",Dt)}function Bt(){Te.removeListener("runCancelled",Dt)}function Dt(){(void 0)("Run cancelled: %s",Ke()),process.exit(1)}var wt,Te,$e=R(()=>{"use strict";o();wt=m(require("events"));P();oe();Te=new wt.default});var Je,J,Ke,ie,vt=R(()=>{"use strict";o();P();$e();Je={cancellationReason:null},J=e=>{Je.cancellationReason||(Je.cancellationReason=e)},Ke=()=>Je.cancellationReason,ie=({showWarning:e=!0}={})=>{let t=Ke();t&&(e&&g("%s",t),Te.emit("runCancelled",t))}});var oe=R(()=>{"use strict";o();vt()});var Mt,Ft,Ye,kt,jt=R(()=>{"use strict";o();Mt=require("axios"),Ft=e=>(0,Mt.isAxiosError)(e)?e.code==="ECONNREFUSED"?!0:!!(e?.response?.status&&500<=e.response.status&&e.response.status<600):!1,Ye=e=>[15*1e3,30*1e3,60*1e3][e-1],kt=()=>process.env.CURRENTS_API_URL??"https://cy.currents.dev"});function Gt(e){!e.response?.data||!e.response?.status||(0,F.match)(e.response).with({status:401},()=>{g("[currents] received 401 Unauthorized Request from cloud service")}).with({status:422},t=>{(0,F.match)(t.data).with({message:F.P.string,errors:F.P.array(F.P.string)},r=>{let{message:s,errors:n}=r;He(1),g(...Gs(s,n)),He(1)}).otherwise(()=>{g("[currents] received 422 Unprocessable Entity from cloud service")})}).otherwise(()=>{S(`Unexpected error from the cloud service: %s
%O`,e.toJSON())})}function Gs(e,t){return Ht.default.isString(e)?t?.length===0?[e]:[e,`
${(t??[]).map(r=>`  - ${r}`).join(`
`)}
`]:["Unexpected error from the cloud service"]}var Ht,F,Vt=R(()=>{"use strict";o();Ht=m(require("lodash")),F=require("ts-pattern");P()});function qt(e){Yt["x-pw-version"]=e??"0.0.0"}function Vs(){return Y||(Y=Re.default.create({baseURL:kt()}),Y.interceptors.request.use(e=>{e.headers.set({...Yt,"x-pwc-request-attempt":e["axios-retry"]?.retryCount??0}),e.headers.set(),e.headers.get("Content-Type")||e.headers.set("Content-Type","application/json");let t={...qe.default.pick(e,"method","url","headers"),data:Buffer.isBuffer(e.data)?"buffer":e.data};return Jt("network request: %o",Ws(t)),e}),(0,$t.default)(Y,{retries:Qt,retryCondition:Ft,retryDelay:Ye,onRetry:$s}),Y)}function Ws(e){return{...e,headers:{...e.headers,["x-currents-key"]:"***"}}}function $s(e,t,r){g("Network request '%s' failed: '%s'. Next attempt is in %s (%d/%d).",`${r.method?.toUpperCase()} ${r.url}`,t.message,(0,Kt.default)(Ye(e)),e,Qt)}function Ks(e){(0,q.match)(e.response?.data).with({code:Wt.RUN_CANCELLED,message:q.P.string},t=>{J(t.message),ie({showWarning:!1})}).with({code:Wt.RUN_EXPIRED,message:q.P.string},()=>{g("This execution will not be recorded because the cloud run is expired.")}).otherwise(t=>{throw t})}var Re,$t,qe,Kt,q,Jt,Yt,Qt,Y,B,Wt,zt=R(()=>{"use strict";o();Re=m(require("axios")),$t=m(require("axios-retry")),qe=m(require("lodash")),Kt=m(require("pretty-ms")),q=require("ts-pattern");_();Lt();oe();P();jt();Vt();Jt=d.extend("api"),Yt={"x-pw-version":"0.0.0","x-pwc-version":Ot};Qt=3,Y=null;B=e=>Vs()(e).then(t=>(Jt("network response: %o",{...qe.default.omit(t,"request","config"),url:t.config.url,method:t.config.method}),t)).catch(t=>{debugger;(0,q.match)(t).when(Re.isAxiosError,r=>{Gt(r),Ks(r)}).otherwise(r=>{throw r})}),Wt={RUN_CANCELLED:"RUN_CANCELLED",RUN_EXPIRED:"RUN_EXPIRED"}});var Q=R(()=>{"use strict";o();We();zt()});var Xt={};Me(Xt,{getDebugUrl:()=>Js});var Js,Zt=R(()=>{"use strict";o();Q();Js=({runId:e,type:t})=>B({method:"POST",url:"runs/debug-logs",data:{type:t,runId:e}}).then(r=>r.data)});var er={};Me(er,{ContentType:()=>Ge,sendBuffer:()=>Ve,sendPath:()=>he,uploadText:()=>ks});var Ie=R(()=>{"use strict";o();We()});function Ys(e){return e==="full"||e==="remote"}function qs(e){return e==="remote"}function ir(e={source:"core",mode:"remote"}){if(e.mode!==!1){let n=process.env.DEBUG?`${process.env.DEBUG},currents*`:"currents*";D.default.enable(n)}if(!Ys(e.mode))return;let t=Fe(),r=sr.default.resolve(rr.default.tmpdir(),`currents-debug_${t}.log`);M(Ee((0,Ce.bgYellow)(`\u{1F47E} Initiated remote ${e.source} debug log collection:`)),C(r));let s=tr.default.createWriteStream(r,{flags:"a"});return D.default.log=(...n)=>{s.write(`${nr.default.format(...n)}
`),qs(e.mode)||Qe(...n)},ze[t]={id:t,writeStream:s,type:e.source,tempFilePath:r},t}async function ar({runId:e}){try{let t=Object.keys(ze);t.length===0&&(or("No debug pipelines found"),D.default.log=Qe);for(let r of t)await Qs(r,e??Fe())}finally{D.default.log=Qe}}async function Qs(e,t){let r=ze[e];if(!r){or("No debug pipeline found for id %s",e);return}M(Ee((0,Ce.bgYellow)(`\u{1F47E} ${r.type} debug log written:`)),C(r?.tempFilePath));let{getDebugUrl:s}=await Promise.resolve().then(()=>(Zt(),Xt));try{let{readUrl:n,uploadUrl:a}=await s({runId:t,type:"pw-debug"}),{uploadText:i}=await Promise.resolve().then(()=>(Ie(),er));await i(r.tempFilePath,a),r?.writeStream.end(),M(Ee((0,Ce.bgYellow)(`\u{1F47E} ${r.type} debug log uploaded:`)),C(n))}catch(n){g(`Failed to upload ${r.type}} debug log ${C(r.tempFilePath)}: ${n.message}`)}}var Ce,D,tr,rr,sr,nr,Qe,or,ze,lr=R(()=>{"use strict";o();Ce=require("colors/safe"),D=m(require("debug")),tr=m(require("fs")),rr=m(require("os")),sr=m(require("path")),nr=m(require("util"));ht();P();Qe=D.default.log,or=(0,D.default)("currents:remote-debug"),ze={}});var Xe=R(()=>{"use strict";o();lr()});var d,_=R(()=>{"use strict";o();Xe();d=(0,D.default)("currents")});var Eo={};Me(Eo,{currentsReporter:()=>go,default:()=>fo});module.exports=Fs(Eo);o();var cc=require("source-map-support/register");o();o();var ws=m(require("fs")),Be=require("ts-pattern");o();_();o();var z=class extends Error{};P();o();o();var ur=require("commander");function cr(e){if(!e)return;if(e==="false")return!1;let t=parseInt(e,10);if(isNaN(t)||t<1)throw new ur.CommanderError(255,"Invalid argument provided.","--pwc-cancel-after-failures must be a positive integer or 'false', provided: "+e);return t}var x={debug:{name:"Debug",env:"CURRENTS_DEBUG",cli:"--pwc-debug"},ciBuildId:{name:"CI Build ID",env:"CURRENTS_CI_BUILD_ID",cli:"--ci-build-id"},recordKey:{name:"Record Key",env:"CURRENTS_RECORD_KEY",cli:"--key"},projectId:{name:"Project ID",env:"CURRENTS_PROJECT_ID",cli:"--project-id"},tag:{name:"Currents Tag",env:"CURRENTS_TAG",cli:"--tag"},cancelAfterFailures:{name:"Currents Cancel After Failures",env:"CURRENTS_CANCEL_AFTER_FAILURES",cli:"--pwc-cancel-after-failures"},disableTitleTags:{name:"Disable Title Tags",env:"CURRENTS_DISABLE_TITLE_TAGS",cli:"--pwc-disable-title-tags"},testSuiteFile:{name:"Test Suite File",env:"CURRENTS_TEST_SUITE_FILE",cli:"--pwc-test-suite-file"}};function _e(e){return x[e].env}function Se(e){return x[e].cli}function pr(e){return x[e].name}function mr(){return{projectId:process.env[x.projectId.env],recordKey:process.env[x.recordKey.env],ciBuildId:process.env[x.ciBuildId.env],tag:process.env[x.tag.env]?process.env[x.tag.env]?.split(",").map(e=>e.trim()):void 0,cancelAfterFailures:cr(process.env[x.cancelAfterFailures.env]),disableTitleTags:process.env[x.disableTitleTags.env],debug:process.env[x.debug.env],testSuiteFile:process.env[x.testSuiteFile.env]}}o();var dr=m(require("fs"));_();function gr(){if(process.env.CURRENTS_PWC_CONFIG_PATH)try{let e=JSON.parse(dr.default.readFileSync(process.env.CURRENTS_PWC_CONFIG_PATH).toString());return d("CLI options from file: %o",e),e}catch{return{}}return{}}var zs=["projectId","recordKey"],et=null;function fr(e){let t={...Ze(e),...Ze(gr()),...Ze(mr())};zs.forEach(r=>{if(!t[r])throw S(`${pr(r)} is required for Currents Reporter. Use the following methods to set Currents Project ID:
- as environment variable: ${C(_e(r))}
- as CLI flag of pwc command: ${C(Se(r))}
- as reporter configuration option ${C(r)} in ${C("playwright.config.ts")}

\u{1F4D6} https://currents.dev/readme/integration-with-playwright/currents-playwright`),new z("Missing required config variable")}),et=t,d("Resolved Currents config: %o",et)}function Ze(e){return Object.entries(e??{}).reduce((t,[r,s])=>s===void 0?t:{...t,[r]:s},{})}function v(){return et}_();Q();$e();P();Xe();o();o();var Yr=m(require("json-stringify-safe")),qr=require("lodash"),te=require("ts-pattern");_();o();o();_();Q();function Er({instanceId:e,tests:t,resultsBody:r}){return B({method:"POST",url:`instances/${e}/pw/results`,data:{results:r,tests:t}}).then(s=>s.data)}function hr({runId:e,groupId:t,machineId:r,worker:s,spec:n}){return d("Creating instance: %o",{runId:e,groupId:t,machineId:r,worker:s,spec:n}),B({method:"POST",url:`runs/${e}/pw/instances`,data:{spec:n,runId:e,groupId:t,machineId:r,worker:s}}).then(a=>a.data)}oe();o();function ae(e){return e!=null}Ie();o();var le=require("lodash");function Tr(e){return{...(0,le.pick)(e,"title","location","results","_only","expectedStatus","timeout","retries"),results:e.results.map(Xs)}}function Xs(e){return{...(0,le.omit)(e,"steps","attachments"),attachments:e.attachments.map(t=>(0,le.omit)(t,"body"))}}o();var _r=m(require("image-size")),G=require("ts-pattern");o();var Rr=m(require("randomstring"));function k(){return Rr.default.generate({length:5,capitalization:"lowercase"})}o();o();o();var ye=m(require("path"));function Ue(e,t){return Zs(ye.default.relative(t,e.file))}function Zs(e){return e.split(ye.default.sep).join(ye.default.posix.sep)}function X(e){return e.parent.project()?.name??"__currents_no_project__"}function j(e){let t=e.titlePath(),r=en(e).title;return t.slice(t.indexOf(r)+1,t.length)}function en(e){let t=e.parent;for(;t.parent?.location;)t=t.parent;return t}function Ir(e,t){return Ue(e.location,t.rootDir)}function Ae(e){return e.id??e._id}var tn={config:{video:!0,videoUploadOnPasses:!0},hooks:[]},rn={body:"",config:{},hookIds:[]};function tt(e){return{...tn,tests:e.map(t=>({...rn,clientId:t.clientId,title:j(t)}))}}function H(e){return e.map(t=>({clientId:t.clientId,results:t.results})).flatMap(({results:t,clientId:r})=>t.flatMap(s=>s.attachments.map(n=>({...n,testId:r,testAttemptIndex:s.retry}))))}function Cr(e){return e.outcome()==="flaky"}function Sr(e){return H(e).filter(t=>t.contentType.startsWith("image")||t.contentType==="application/octet-stream").map(t=>(0,G.match)(t).with({path:G.P.string,body:G.P.nullish},r=>{let{height:s,width:n}=sn(t.path);return{screenshotId:k(),name:r.name,testId:r.testId,testAttemptIndex:r.testAttemptIndex,path:r.path,height:s,width:n,takenAt:new Date}}).with({path:G.P.nullish,body:G.P.instanceOf(Uint8Array)},r=>({screenshotId:k(),name:r.name,testId:r.testId,testAttemptIndex:r.testAttemptIndex,path:r.path,height:0,width:0,body:r.body,takenAt:new Date})).otherwise(()=>null)).filter(ae)}function sn(e){if(!e)return{height:0,width:0};try{let{height:t,width:r}=(0,_r.default)(e);return{height:t,width:r}}catch{return{height:0,width:0}}}o();var Ar=require("date-fns"),O=require("lodash");_();o();var yr=require("lodash"),Ur=require("ts-pattern");function nn(e){if(!e.results?.length)return"skipped";let t=e.results.map(r=>r.status);return t.every(r=>r===t[0])?(0,Ur.match)(t[0]).with("skipped",()=>"skipped").with("passed",()=>e.expectedStatus==="passed"?"passed":"failed").with("failed",()=>e.expectedStatus==="failed"?"passed":"failed").otherwise(()=>"failed"):e.results.some(r=>r.status==="passed")&&e.expectedStatus==="passed"||e.results.some(r=>r.status==="failed")&&e.expectedStatus==="failed"?"passed":"failed"}function rt(e){switch(e){case"timedOut":return"failed";case"interrupted":return"failed";case"skipped":return"pending";default:return e}}var Z=(0,yr.flowRight)(rt,nn);function Pr(e){let t=e.map(on),r=(0,O.first)(t.map(a=>a.wallClockStartedAt).sort())??new Date,s=(0,O.last)(t.map(a=>a.wallClockEndedAt).sort())??new Date,n=(0,Ar.differenceInMilliseconds)(s,r);return{suites:1,tests:e.length,passes:(0,O.sumBy)(t,"passes"),pending:(0,O.sumBy)(t,"pending"),skipped:(0,O.sumBy)(t,"skipped"),failures:(0,O.sumBy)(t,"failures"),wallClockStartedAt:r,wallClockEndedAt:s,wallClockDuration:n}}function on(e){d("getting test stats for test case: %o",(0,O.omit)(e,"_testType","parent","fn"));let t=e.results.map(T=>T.startTime),r=e.results.map(T=>new Date(new Date(T.startTime).getTime()+T.duration)),s=t.sort((T,I)=>T.getTime()-I.getTime()),n=r.sort((T,I)=>T.getTime()-I.getTime()),a=s[0]||new Date,i=n[n.length-1]||new Date,c=i.getTime()-a.getTime(),u=Z(e),p={passes:["passed"].includes(u)?1:0,pending:["pending"].includes(u)?1:0,skipped:["skipped"].includes(u)?1:0,failures:["failed"].includes(u)?1:0,wallClockStartedAt:a,wallClockEndedAt:i,wallClockDuration:c};return d("test stats result: %o",p),p}function xr(e){return{suites:1,tests:e.tests,passes:e.passes,pending:e.pending,failures:e.failures,start:e.wallClockStartedAt,end:e.wallClockEndedAt,duration:e.wallClockDuration}}o();var ot=require("lodash");o();var br=require("@babel/code-frame"),Or=m(require("fs")),Pe=require("lodash"),xe=m(require("path"));o();var an=new RegExp("([\\u001B\\u009B][[\\]()#;?]*(?:(?:(?:[a-zA-Z\\d]*(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]*)*)?\\u0007)|(?:(?:\\d{1,4}(?:;\\d{0,4})*)?[\\dA-PR-TZcf-ntqry=><~])))","g");function ee(e){return e.replace(an,"")}var Lr={message:"Test interrupted",name:"Error",stack:"",codeFrame:void 0};function wr(e){if(!e.results?.length)return Lr.message;let t=(0,Pe.orderBy)(e.results,"retry","asc"),r=(0,Pe.last)(t.filter(s=>s.status==="failed"||s.status==="timedOut"||s.status==="interrupted"))?.error?.message;return r?ee(r):null}function Nr(e,t){if(e.status==="interrupted")return Lr;if(!e.error)return null;if(e.error)return nt(e.error,t);let r=st(e.steps);return r?(r?.error||(r.error=e.error),{message:Br(r.error),name:r.title,stack:Dr(r.error),codeFrame:cn(r)}):null}function nt(e,t){try{return{message:Br(e),name:ln(e),stack:Dr(e),codeFrame:e.location&&un({location:e.location,snippet:e.snippet,project:t})}}catch{return{message:"Error while getting error details",name:"Error",stack:"",codeFrame:void 0}}}function ln(e){return"Error"}function un({location:e,snippet:t,project:r}){return{line:e.line,column:e.column,originalFile:e.file,relativeFile:r?.testDir?xe.default.relative(r.testDir,e.file):null,absoluteFile:e.file,frame:ee(t??"No error source code detected"),language:vr(e.file)}}function st(e,t=3){let r;for(let s of e){if(s.error&&s.location&&(r=s),r)return r;s.steps.length>0&&t>0&&(r=st(s.steps,t-1))}for(let s of e){if(s.category==="hook"&&s.location&&(r=s),r)return r;s.steps.length>0&&t>0&&(r=st(s.steps,t-1))}return r}function Br(e){return typeof e=="string"?e:ee(e?.message??"")}function Dr(e){return e!==void 0&&"stack"in e&&e.stack?e.stack:""}function cn(e){let{location:t}=e;if(!t)return;let r=vr(t.file),s=t.file,n=xe.default.relative(process.cwd(),t.file),a=n,i=t.column,c=t.line,u=pn(t.file),p=u?(0,br.codeFrameColumns)(u,{start:{line:c,column:i}}):"";return{line:c,column:i,originalFile:a,relativeFile:n,absoluteFile:s,frame:p,language:r}}var vr=e=>(xe.default.extname(e)||"").toLowerCase().replace(".",""),pn=e=>{try{return Or.default.readFileSync(e,"utf-8")+`
//`}catch{return}};function Mr(e){return e.map(t=>{let r=mn(t),s=t.results.map(n=>({rawStatus:n.status,state:rt(n.status),error:Nr(n,r),errors:n.errors.map(a=>nt(a,r)),wallClockStartedAt:n.startTime.toISOString(),wallClockDuration:n.duration,videoTimestamp:0,workerIndex:n.workerIndex}));return{title:j(t),expectedStatus:t.expectedStatus,outcome:t.outcome(),worker:it(t),clientId:t.clientId,displayError:wr(t),state:Z(t),annotations:t.annotations,isFlaky:Cr(t),attempts:s}})}function it(e){return{workerIndex:(0,ot.isNil)(e.results[0]?.workerIndex)?-1:e.results[0].workerIndex,parallelIndex:(0,ot.isNil)(e.results[0]?.parallelIndex)?-1:e.results[0].parallelIndex}}function mn(e){return e.parent.project()}o();function Fr(e){return H(e).filter(t=>t.name==="trace").filter(t=>"path"in t).map(t=>({traceId:k(),name:t.name,testId:t.testId,testAttemptIndex:t.testAttemptIndex,path:t.path,takenAt:new Date}))}o();var Hr=require("lodash"),Gr=m(require("p-all")),ue=require("ts-pattern"),Vr=require("util");_();P();Ie();var at=d.extend("upload"),be=new Set,kr=e=>({total:t,loaded:r})=>{},Wr=({instanceId:e,uploads:t})=>(0,Gr.default)(t.map(r=>async()=>{try{await(0,ue.match)(r).with({path:ue.P.string},async s=>{await he(s,s.contentType,kr(s.path)),at("Upload completed for %s, %s",e,s.path)}).with({buffer:ue.P.any},async s=>{await Ve(s,s.contentType,kr(s.name??"buffer")),at("Upload completed for %s, %s",e,s.name)}).exhaustive()}catch(s){let n=(0,Vr.format)("Upload failed: %o",dn(s));be.add(n),g(n)}}),{concurrency:10,stopOnError:!1});function dn(e){return(0,Hr.pick)(e,"message","code","method","url")}function jr(e){return e/1e3/1e3}o();function $r(e){let s=H(e).filter(n=>n.contentType.startsWith("video"))[0];return s&&s.path?{type:"hasVideo",path:s.path,name:s.name}:{type:"noVideo"}}function Kr(e){return H(e).filter(t=>t.contentType.startsWith("video")).map(t=>({...t,id:k()}))}async function Qr({instanceId:e,testCases:t,stdout:r}){let s=Rn(t),n=gn(s);d("Results for instance %s: %o",e,(0,qr.omit)(n,"raw"));let{cloud:a,...i}=await Er({instanceId:e,tests:tt(t),resultsBody:n});a?.shouldCancel&&(d("instance %s should cancel",e),J(a.shouldCancel));let c=[...En({videos:s.videos,videoAssets:i.videoAssets}),...hn({screenshots:s.screenshots,screenshotUploadUrls:i.screenshotUploadUrls}),...Tn({playwrightTraces:s.playwrightTraces,playwrightTraceUrls:i.playwrightTraceUrls}),{name:"stdout",buffer:Buffer.from(r.length?r:fn(t)),uploadUrl:i.stdoutUploadUrl,contentType:"text/plain"}];return Wr({instanceId:e,uploads:c.filter(ae)})}function gn(e){return{...e,videos:e.videos.map(Jr),screenshots:e.screenshots.map(Jr)}}function Jr(e){return e.body?{...e,body:Buffer.from("redacted")}:e}function fn(e){return`No console output was generated during execution of the tests:
${e.map(t=>`- ${t.location.file}: ${t.title}`).join(`
`)}`}function En({videos:e,videoAssets:t}){return t.map(r=>{let s=e.find(n=>n.id===r.id);return{...r,name:s?.name??r.name??null,path:s?.path??r.path??void 0,body:s?.body,contentType:"video/webm"}})}function hn({screenshots:e,screenshotUploadUrls:t}){return t.map(r=>{let s=e.find(n=>n.screenshotId===r.screenshotId);if(s)return(0,te.match)(s).with({path:te.P.string},n=>({name:n.name,path:n.path,uploadUrl:r.uploadUrl,contentType:"image/png"})).with({body:te.P.instanceOf(Buffer)},n=>({name:n.name,buffer:n.body,uploadUrl:r.uploadUrl,contentType:"image/png"})).exhaustive()}).filter(ae)}function Tn({playwrightTraces:e,playwrightTraceUrls:t=[]}){return t.map(r=>{let s=e.find(n=>n.traceId===r.traceId);if(s?.path)return{name:s.name,path:s.path,uploadUrl:r.uploadUrl,contentType:"application/zip"}})}function Rn(e){let t=Pr(e),r=xr(t),s=$r(e),n=Kr(e),a=Sr(e),i=Fr(e);return{stats:t,reporterStats:r,video:s.type==="hasVideo",videos:n,screenshots:a,playwrightTraces:i,exception:null,tests:Mr(e),raw:In(e)}}var In=e=>(0,te.match)((0,Yr.default)(e.map(Tr))).when(t=>Cn(t)<5,t=>t).otherwise(()=>"toobig");function Cn(e){return Buffer.byteLength(e,"utf8")/(1024*1024)}o();o();var W=require("lodash"),Os=m(require("pluralize"));_();o();var h=m(require("chalk")),Le=m(require("path"));o();var zr=m(require("url")),ut=m(require("fs")),re=m(require("path")),ce=m(require("colors/safe")),Xr=require("@babel/code-frame"),Zr=m(require("stack-utils"));function lt(e,t){return e.replace(/^(?=.+$)/gm,t)}function _n(e){let t=e.split(`
`),r=t.findIndex(i=>i.startsWith("    at "));r===-1&&(r=t.length);let s=t.slice(0,r).join(`
`),n=t.slice(r),a;for(let i of n){let{frame:c,fileName:u}=Pn(i);if(!(!c||!u)&&!Sn(u)){a={file:u,column:c.column||0,line:c.line||0};break}}return{message:s,stackLines:n,location:a}}function Sn(e){return e.includes(`${re.default.sep}node_modules${re.default.sep}`)}function yn(e,t){return re.default.relative(e.rootDir,t)||re.default.basename(t)}function Un(e,t,r,s){let n=t.stack,a=[],i;if(n){let c=_n(n);if(a.push(c.message),i=c.location,i)try{let u=ut.default.readFileSync(i.file,"utf8"),p=(0,Xr.codeFrameColumns)(u,{start:i},{highlightCode:r});(!s||ut.default.realpathSync(s)!==i.file)&&(a.push(""),a.push(ce.gray("   at ")+`${yn(e,i.file)}:${i.line}`)),a.push(""),a.push(p)}catch{}a.push(""),a.push(c.stackLines.join(`
`))}else t.message?a.push(t.message):t.value&&a.push(t.value);return{location:i,message:a.join(`
`)}}var An=new Zr.default;function Pn(e){let t=An.parseLine(e);if(!t)return{frame:null,fileName:null};let r=null;return t.file&&(r=t.file.startsWith("file://")?zr.default.fileURLToPath(t.file):re.default.resolve(process.cwd(),t.file)),{frame:t,fileName:r}}function es(e,t,r,s,n){let a=[];r.status==="passed"&&t.expectedStatus==="failed"&&a.push({message:lt(ce.red("Expected to fail, but passed."),s)}),r.status==="interrupted"&&a.push({message:lt(ce.red("Test was interrupted."),s)});for(let i of r.errors){let c=Un(e,i,n,t.location.file);a.push({message:lt(c.message,s),location:c.location})}return a}var xn=Symbol("output");function bn({skipped:e,expected:t,interrupted:r,unexpected:s,flaky:n,fatalErrors:a},i,c){let u=[];if(s.length){u.push(h.default.red(`  ${s.length} failed`));for(let p of s)u.push(h.default.red(Oe(i,p,"    ")))}if(r.length){u.push(h.default.yellow(`  ${r.length} interrupted`));for(let p of r)u.push(h.default.yellow(Oe(i,p,"    ")))}if(n.length){u.push(h.default.yellow(`  ${n.length} flaky`));for(let p of n)u.push(h.default.yellow(Oe(i,p,"    ")))}return e&&u.push(h.default.yellow(`  ${e} skipped`)),c.status==="timedout"&&u.push(h.default.red(`  Timed out waiting ${i.globalTimeout/1e3}s for the entire test run`)),a.length&&u.push(h.default.red(`  ${a.length===1?"1 error was not a part of any test":a.length+" errors were not a part of any test"}, see above for details`)),u.join(`
`)}function On(e){let t=0,r=0,s=[],n=[],a=[],i=[];e.forEach(u=>{switch(u.outcome()){case"skipped":{u.results.some(p=>p.status==="interrupted")?(u.results.some(p=>!!p.error)&&n.push(u),s.push(u)):++t;break}case"expected":++r;break;case"unexpected":a.push(u);break;case"flaky":i.push(u);break}});let c=[...a,...i,...n];return{skipped:t,expected:r,interrupted:s,unexpected:a,flaky:i,failuresToPrint:c,fatalErrors:[]}}function rs(e,t,r){let s=On(e);return{summaryMessage:bn(s,t,r),failures:s.failuresToPrint.map((a,i)=>Ln(t,a,{index:i+1}).message)}}function Ln(e,t,r={}){let{index:s,includeStdio:n,includeAttachments:a=!0}=r,i=[],c=ss(e,t),u=[],p=Oe(e,t,"  ",s);i.push(h.default.red(p));for(let T of t.results){let I=[],De=es(e,t,T,"    ",!0);if(!De.length)continue;let de=[];if(T.retry&&(de.push(""),de.push(h.default.gray(se(`    Retry #${T.retry}`,"-")))),I.push(...de),I.push(...De.map(b=>`
`+b.message)),a)for(let b=0;b<T.attachments.length;++b){let U=T.attachments[b],ve=U.contentType.startsWith("text/")&&U.body;if(!(!U.path&&!ve)){if(I.push(""),I.push(h.default.cyan(se(`    attachment #${b+1}: ${U.name} (${U.contentType})`,"-"))),U.path){let w=Le.default.relative(process.cwd(),U.path);I.push(h.default.cyan(`    ${w}`)),U.name==="trace"&&(I.push(h.default.cyan("    Usage:")),I.push(""),I.push(h.default.cyan(`        npx playwright show-trace ${w}`)),I.push(""))}else if(U.contentType.startsWith("text/")&&U.body){let w=U.body.toString();w.length>300&&(w=w.slice(0,300)+"..."),I.push(h.default.cyan(`    ${w}`))}I.push(h.default.cyan(se("   ","-")))}}let gt=T[xn]||[];if(n&&gt.length){let b=gt.map(({chunk:U,type:ve})=>{let w=U.toString("utf8");return ve==="stderr"?h.default.red(ee(w)):w}).join("");I.push(""),I.push(h.default.gray(se("--- Test output","-"))+`

`+b+`
`+se("","-"))}for(let b of De)u.push({location:b.location,title:c,message:[p,...de,b.message].join(`
`)});i.push(...I)}return i.push(""),{message:i.join(`
`),annotations:u}}function Oe(e,t,r,s){let n=ss(e,t),a=`${r}${s?s+") ":""}${n}`;return se(a,"=")}function ss(e,t,r,s=!1){let[,n,,...a]=t.titlePath(),i;return s?i=`${ts(e,t)}`:i=`${ts(e,t)}:${r?.location?.line??t.location.line}:${r?.location?.column??t.location.column}`,`${n?`[${n}] \u203A `:""}${i} \u203A ${a.join(" \u203A ")}${Nn(r)}`}function se(e,t){return e&&(e+=" "),e+h.default.gray(t.repeat(Math.max(0,100-e.length)))}function wn(e,t){return Le.default.relative(e.rootDir,t)||Le.default.basename(t)}function ts(e,t){return wn(e,t.location.file)}function Nn(e){return(e?e.titlePath():[]).map(r=>" \u203A "+r).join("")}o();_();var Bn=d.extend("state"),ct=class{constructor(t,r){this.projectId=r;this._testCase=t}_testCase;get testCase(){return this._testCase}get titlePath(){return`${this.testCase.titlePath().filter(Boolean).join(" > ")}`}get currentsState(){return Z(this.testCase)}isFinished(){let t=this.testCase.results.map(r=>r.status);return Bn("isFinished?: %o",{title:this.titlePath,allStatuses:t,retries:this.testCase.retries}),!!(t.includes(this.testCase.expectedStatus)||t.length===this.testCase.retries+1)}setTestCase(t){return this._testCase=t,this}backfillMissingTestResults(){}},pt=class{constructor(t,r){this.specName=t;this.projectId=r}testExecutions={};createTestExecution(t,r){this.testExecutions[t]=new ct(r,this.projectId)}getTestExecution(t){return this.testExecutions[t]}getAllTestExecutions(){return Object.values(this.testExecutions)}isFinished(){return this.getAllTestExecutions().every(t=>t.isFinished())}isFailed(){return this.getAllTestExecutions().map(t=>t.currentsState).some(t=>t==="failed")}},mt=class{constructor(t){this.projectId=t}specExecutions={};run=Promise.resolve(null);setRun(t){return this.run=t,this}upsertSpecExecution(t,r){return this.specExecutions[t]||(this.specExecutions[t]=new pt(t,r)),this.specExecutions[t]}getSpecExecution(t){return this.specExecutions[t]}getAllSpecExecutions(){return Object.values(this.specExecutions)}},we=class{constructor(t){this.config=t}projectExecutions={};upsertProjectExecution(t){return this.projectExecutions[t]||(this.projectExecutions[t]=new mt(t)),this.projectExecutions[t]}getProjectExecution(t){return this.projectExecutions[t]}getAllProjectExecutions(){return Object.values(this.projectExecutions)}getAllSpecExecutions(){return Object.values(this.projectExecutions).flatMap(t=>t.getAllSpecExecutions())}getAllTestExecutions(){return this.getAllSpecExecutions().flatMap(t=>t.getAllTestExecutions())}getProjectExecutionForTestCase(t){return this.getProjectExecution(X(t))}getSpecExecution(t){return this.getProjectExecutionForTestCase(t).getSpecExecution(Ir(t,this.config))}getTestExecution(t){return this.getSpecExecution(t).getTestExecution(Ae(t))}};oe();P();o();var ns=m(require("json-stringify-safe"));Q();function os(e){return B({method:"POST",url:"test-result",data:{...e,result:(0,ns.default)(Dn(e.result))}}).then(t=>t.data)}function Dn(e){return{...e,attachments:e.attachments.map(t=>({...t,body:t.body?"redacted":void 0}))}}o();o();var Rs=require("lodash");_();o();var f=require("lodash");o();_();P();var V=d.extend("ci"),vn=(e,...t)=>(0,f.chain)(t).compact().join(e).value(),Mn=(e,t)=>(0,f.set)(e,(0,f.camelCase)(t),process.env[t]),E=e=>(0,f.transform)(e,Mn,{}),Fn=()=>process.env.TF_BUILD&&process.env.TF_BUILD_BUILDNUMBER,kn=()=>process.env.TF_BUILD&&process.env.AZURE_HTTP_USER_AGENT,jn=()=>(0,f.some)(process.env,(e,t)=>/^CODEBUILD_/.test(t)),Hn=()=>process.env.bamboo_buildNumber,Gn=()=>process.env.CI_NAME&&process.env.CI_NAME==="codeship"&&process.env.CODESHIP,Vn=()=>process.env.CI_NAME&&process.env.CI_NAME==="codeship"&&!process.env.CODESHIP,Wn=()=>(0,f.some)(process.env,(e,t)=>/^CONCOURSE_/.test(t)),$n=()=>process.env.GITLAB_CI||process.env.CI_SERVER_NAME&&/^GitLab/.test(process.env.CI_SERVER_NAME),Kn=()=>process.env.GCP_PROJECT||process.env.GCLOUD_PROJECT||process.env.GOOGLE_CLOUD_PROJECT,Jn=()=>process.env.JENKINS_URL||process.env.JENKINS_HOME||process.env.JENKINS_VERSION||process.env.HUDSON_URL||process.env.HUDSON_HOME,Yn=()=>process.env.WERCKER||process.env.WERCKER_MAIN_PIPELINE_STARTED,qn={appveyor:"APPVEYOR",azure:kn,awsCodeBuild:jn,bamboo:Hn,bitbucket:"BITBUCKET_BUILD_NUMBER",buildkite:"BUILDKITE",circle:"CIRCLECI",codeshipBasic:Gn,codeshipPro:Vn,concourse:Wn,codeFresh:"CF_BUILD_ID",drone:"DRONE",githubActions:"GITHUB_ACTIONS",gitlab:$n,goCD:"GO_JOB_NAME",googleCloud:Kn,jenkins:Jn,semaphore:"SEMAPHORE",shippable:"SHIPPABLE",teamcity:"TEAMCITY_VERSION",teamfoundation:Fn,travis:"TRAVIS",wercker:Yn,netlify:"NETLIFY",layerci:"LAYERCI"};function Qn(){let{env:e}=process;return(0,f.findKey)(qn,t=>{if((0,f.isString)(t))return e[t];if((0,f.isFunction)(t))return t()})}var is=()=>({appveyor:E(["APPVEYOR_JOB_ID","APPVEYOR_ACCOUNT_NAME","APPVEYOR_PROJECT_SLUG","APPVEYOR_BUILD_NUMBER","APPVEYOR_BUILD_VERSION","APPVEYOR_PULL_REQUEST_NUMBER","APPVEYOR_PULL_REQUEST_HEAD_REPO_BRANCH"]),azure:E(["BUILD_BUILDID","BUILD_BUILDNUMBER","BUILD_CONTAINERID","BUILD_REPOSITORY_URI"]),awsCodeBuild:E(["CODEBUILD_BUILD_ID","CODEBUILD_BUILD_NUMBER","CODEBUILD_RESOLVED_SOURCE_VERSION","CODEBUILD_SOURCE_REPO_URL","CODEBUILD_SOURCE_VERSION"]),bamboo:E(["bamboo_buildNumber","bamboo_buildResultsUrl","bamboo_planRepository_repositoryUrl","bamboo_buildKey"]),bitbucket:E(["BITBUCKET_REPO_SLUG","BITBUCKET_REPO_OWNER","BITBUCKET_BUILD_NUMBER","BITBUCKET_PARALLEL_STEP","BITBUCKET_STEP_RUN_NUMBER","BITBUCKET_PR_ID","BITBUCKET_PR_DESTINATION_BRANCH","BITBUCKET_PR_DESTINATION_COMMIT"]),buildkite:E(["BUILDKITE_REPO","BUILDKITE_SOURCE","BUILDKITE_JOB_ID","BUILDKITE_BUILD_ID","BUILDKITE_BUILD_URL","BUILDKITE_BUILD_NUMBER","BUILDKITE_PULL_REQUEST","BUILDKITE_PULL_REQUEST_REPO","BUILDKITE_PULL_REQUEST_BASE_BRANCH"]),circle:E(["CIRCLE_JOB","CIRCLE_BUILD_NUM","CIRCLE_BUILD_URL","CIRCLE_PR_NUMBER","CIRCLE_PR_REPONAME","CIRCLE_PR_USERNAME","CIRCLE_COMPARE_URL","CIRCLE_WORKFLOW_ID","CIRCLE_PULL_REQUEST","CIRCLE_REPOSITORY_URL","CI_PULL_REQUEST"]),codeshipBasic:E(["CI_BUILD_ID","CI_REPO_NAME","CI_BUILD_URL","CI_PROJECT_ID","CI_BUILD_NUMBER","CI_PULL_REQUEST"]),codeshipPro:E(["CI_BUILD_ID","CI_REPO_NAME","CI_PROJECT_ID"]),concourse:E(["BUILD_ID","BUILD_NAME","BUILD_JOB_NAME","BUILD_PIPELINE_NAME","BUILD_TEAM_NAME","ATC_EXTERNAL_URL"]),codeFresh:E(["CF_BUILD_ID","CF_BUILD_URL","CF_CURRENT_ATTEMPT","CF_STEP_NAME","CF_PIPELINE_NAME","CF_PIPELINE_TRIGGER_ID","CF_PULL_REQUEST_ID","CF_PULL_REQUEST_IS_FORK","CF_PULL_REQUEST_NUMBER","CF_PULL_REQUEST_TARGET"]),drone:E(["DRONE_JOB_NUMBER","DRONE_BUILD_LINK","DRONE_BUILD_NUMBER","DRONE_PULL_REQUEST"]),githubActions:E(["GITHUB_WORKFLOW","GITHUB_ACTION","GITHUB_EVENT_NAME","GITHUB_RUN_ID","GITHUB_RUN_ATTEMPT","GITHUB_REPOSITORY"]),gitlab:E(["CI_PIPELINE_ID","CI_PIPELINE_URL","CI_BUILD_ID","CI_JOB_ID","CI_JOB_URL","CI_JOB_NAME","GITLAB_HOST","CI_PROJECT_ID","CI_PROJECT_URL","CI_REPOSITORY_URL","CI_ENVIRONMENT_URL","CI_DEFAULT_BRANCH"]),goCD:E(["GO_SERVER_URL","GO_ENVIRONMENT_NAME","GO_PIPELINE_NAME","GO_PIPELINE_COUNTER","GO_PIPELINE_LABEL","GO_STAGE_NAME","GO_STAGE_COUNTER","GO_JOB_NAME","GO_TRIGGER_USER","GO_REVISION","GO_TO_REVISION","GO_FROM_REVISION","GO_MATERIAL_HAS_CHANGED"]),googleCloud:E(["BUILD_ID","PROJECT_ID","REPO_NAME","BRANCH_NAME","TAG_NAME","COMMIT_SHA","SHORT_SHA"]),jenkins:E(["BUILD_ID","BUILD_URL","BUILD_NUMBER","ghprbPullId"]),semaphore:E(["SEMAPHORE_BRANCH_ID","SEMAPHORE_BUILD_NUMBER","SEMAPHORE_CURRENT_JOB","SEMAPHORE_CURRENT_THREAD","SEMAPHORE_EXECUTABLE_UUID","SEMAPHORE_GIT_BRANCH","SEMAPHORE_GIT_DIR","SEMAPHORE_GIT_REF","SEMAPHORE_GIT_REF_TYPE","SEMAPHORE_GIT_REPO_SLUG","SEMAPHORE_GIT_SHA","SEMAPHORE_GIT_URL","SEMAPHORE_JOB_COUNT","SEMAPHORE_JOB_ID","SEMAPHORE_JOB_NAME","SEMAPHORE_JOB_UUID","SEMAPHORE_PIPELINE_ID","SEMAPHORE_PLATFORM","SEMAPHORE_PROJECT_DIR","SEMAPHORE_PROJECT_HASH_ID","SEMAPHORE_PROJECT_ID","SEMAPHORE_PROJECT_NAME","SEMAPHORE_PROJECT_UUID","SEMAPHORE_REPO_SLUG","SEMAPHORE_TRIGGER_SOURCE","SEMAPHORE_WORKFLOW_ID","PULL_REQUEST_NUMBER"]),shippable:E(["SHIPPABLE_BUILD_ID","SHIPPABLE_BUILD_NUMBER","SHIPPABLE_COMMIT_RANGE","SHIPPABLE_CONTAINER_NAME","SHIPPABLE_JOB_ID","SHIPPABLE_JOB_NUMBER","SHIPPABLE_REPO_SLUG","IS_FORK","IS_GIT_TAG","IS_PRERELEASE","IS_RELEASE","REPOSITORY_URL","REPO_FULL_NAME","REPO_NAME","BUILD_URL","BASE_BRANCH","HEAD_BRANCH","IS_PULL_REQUEST","PULL_REQUEST","PULL_REQUEST_BASE_BRANCH","PULL_REQUEST_REPO_FULL_NAME"]),teamcity:null,teamfoundation:E(["BUILD_BUILDID","BUILD_BUILDNUMBER","BUILD_CONTAINERID"]),travis:E(["TRAVIS_JOB_ID","TRAVIS_BUILD_ID","TRAVIS_BUILD_WEB_URL","TRAVIS_REPO_SLUG","TRAVIS_JOB_NUMBER","TRAVIS_EVENT_TYPE","TRAVIS_COMMIT_RANGE","TRAVIS_BUILD_NUMBER","TRAVIS_PULL_REQUEST","TRAVIS_PULL_REQUEST_BRANCH","TRAVIS_PULL_REQUEST_SHA"]),wercker:null,netlify:E(["BUILD_ID","CONTEXT","URL","DEPLOY_URL","DEPLOY_PRIME_URL","DEPLOY_ID"]),layerci:E(["LAYERCI_JOB_ID","LAYERCI_RUNNER_ID","RETRY_INDEX","LAYERCI_PULL_REQUEST","LAYERCI_REPO_NAME","LAYERCI_REPO_OWNER","LAYERCI_BRANCH","GIT_TAG"])}),zn=()=>{let{env:e}=process;return{appveyor:{sha:e.APPVEYOR_REPO_COMMIT,branch:e.APPVEYOR_PULL_REQUEST_HEAD_REPO_BRANCH||e.APPVEYOR_REPO_BRANCH,message:vn(`
`,e.APPVEYOR_REPO_COMMIT_MESSAGE,e.APPVEYOR_REPO_COMMIT_MESSAGE_EXTENDED),authorName:e.APPVEYOR_REPO_COMMIT_AUTHOR,authorEmail:e.APPVEYOR_REPO_COMMIT_AUTHOR_EMAIL},awsCodeBuild:{sha:e.CODEBUILD_RESOLVED_SOURCE_VERSION,remoteOrigin:e.CODEBUILD_SOURCE_REPO_URL},azure:{sha:e.BUILD_SOURCEVERSION,branch:e.BUILD_SOURCEBRANCHNAME,message:e.BUILD_SOURCEVERSIONMESSAGE,authorName:e.BUILD_SOURCEVERSIONAUTHOR,authorEmail:e.BUILD_REQUESTEDFOREMAIL},bamboo:{sha:e.bamboo_planRepository_revision,branch:e.bamboo_planRepository_branch,authorName:e.bamboo_planRepository_username,remoteOrigin:e.bamboo_planRepository_repositoryURL},bitbucket:{sha:e.BITBUCKET_COMMIT,branch:e.BITBUCKET_BRANCH},buildkite:{sha:e.BUILDKITE_COMMIT,branch:e.BUILDKITE_BRANCH,message:e.BUILDKITE_MESSAGE,authorName:e.BUILDKITE_BUILD_CREATOR,authorEmail:e.BUILDKITE_BUILD_CREATOR_EMAIL,remoteOrigin:e.BUILDKITE_REPO,defaultBranch:e.BUILDKITE_PIPELINE_DEFAULT_BRANCH},circle:{sha:e.CIRCLE_SHA1,branch:e.CIRCLE_BRANCH,authorName:e.CIRCLE_USERNAME,remoteOrigin:e.CIRCLE_REPOSITORY_URL},codeshipBasic:{sha:e.CI_COMMIT_ID,branch:e.CI_BRANCH,message:e.CI_COMMIT_MESSAGE,authorName:e.CI_COMMITTER_NAME,authorEmail:e.CI_COMMITTER_EMAIL},codeshipPro:{sha:e.CI_COMMIT_ID,branch:e.CI_BRANCH,message:e.CI_COMMIT_MESSAGE,authorName:e.CI_COMMITTER_NAME,authorEmail:e.CI_COMMITTER_EMAIL},codeFresh:{sha:e.CF_REVISION,branch:e.CF_BRANCH,message:e.CF_COMMIT_MESSAGE,authorName:e.CF_COMMIT_AUTHOR},drone:{sha:e.DRONE_COMMIT_SHA,branch:e.DRONE_SOURCE_BRANCH,message:e.DRONE_COMMIT_MESSAGE,authorName:e.DRONE_COMMIT_AUTHOR,authorEmail:e.DRONE_COMMIT_AUTHOR_EMAIL,remoteOrigin:e.DRONE_GIT_HTTP_URL,defaultBranch:e.DRONE_REPO_BRANCH},githubActions:{sha:e.GITHUB_SHA,branch:e.GH_BRANCH||e.GITHUB_REF,defaultBranch:e.GITHUB_BASE_REF,remoteBranch:e.GITHUB_HEAD_REF,runAttempt:e.GITHUB_RUN_ATTEMPT},gitlab:{sha:e.CI_COMMIT_SHA,branch:e.CI_COMMIT_REF_NAME,message:e.CI_COMMIT_MESSAGE,authorName:e.GITLAB_USER_NAME,authorEmail:e.GITLAB_USER_EMAIL,remoteOrigin:e.CI_REPOSITORY_URL,defaultBranch:e.CI_DEFAULT_BRANCH},googleCloud:{sha:e.COMMIT_SHA,branch:e.BRANCH_NAME},jenkins:{sha:e.GIT_COMMIT,branch:e.GIT_BRANCH},semaphore:{sha:e.SEMAPHORE_GIT_SHA,branch:e.SEMAPHORE_GIT_BRANCH,remoteOrigin:e.SEMAPHORE_GIT_REPO_SLUG},shippable:{sha:e.COMMIT,branch:e.BRANCH,message:e.COMMIT_MESSAGE,authorName:e.COMMITTER},snap:null,teamcity:null,teamfoundation:{sha:e.BUILD_SOURCEVERSION,branch:e.BUILD_SOURCEBRANCHNAME,message:e.BUILD_SOURCEVERSIONMESSAGE,authorName:e.BUILD_SOURCEVERSIONAUTHOR},travis:{sha:e.TRAVIS_PULL_REQUEST_SHA||e.TRAVIS_COMMIT,branch:e.TRAVIS_PULL_REQUEST_BRANCH||e.TRAVIS_BRANCH,message:e.TRAVIS_COMMIT_MESSAGE},wercker:null,netlify:{sha:e.COMMIT_REF,branch:e.BRANCH,remoteOrigin:e.REPOSITORY_URL},layerci:{sha:e.GIT_COMMIT,branch:e.LAYERCI_BRANCH,message:e.GIT_COMMIT_TITLE}}},as=e=>{let t=ls();return t?(0,f.chain)(e()).get(t).value():{}};function Xn(e){if(e&&Zn().includes(e))return!0;throw S(`Currents failed to automatically detect CI build ID for this environment. Please use one of the following to set CI build ID:
  
- use environment variable: ${C(_e("ciBuildId"))}
- as CLI flag of pwc command: ${C(Se("ciBuildId"))}
- as reporter configuration option ${C("ciBuildId")} in ${C("playwright.config.ts")}

\u{1F4D6} https://currents.dev/readme/guides/ci-build-id
\u{1F4D6} https://currents.dev/readme/integration-with-playwright/currents-playwright
`),new Error("We could not determine a unique CI Build ID")}function Zn(){return(0,f.chain)(is()).omitBy(f.isNull).keys().value()}function ls(){return Qn()||null}function eo(){return as(is)}function to(){return as(zn)}function us(e){let t=eo(),r=ls();return e||Xn(r),V("detected CI provider: %s",r),V("detected CI params: %O",t),{params:t,provider:r}}function cs(e){V("git commit existing info"),V(e);let t=to();V("commit info from provider environment variables: %O",t);let r=(0,f.transform)(e,(s,n,a)=>s[a]=(0,f.defaultTo)(n||t[a],null));return V("combined git and environment variables from provider"),V(r),r}o();var ps=require("@currents/commit-info"),ms=require("lodash");var ro=async()=>{let e=await(0,ps.commitInfo)();return cs({branch:e.branch,remoteOrigin:e.remote,authorEmail:e.email,authorName:e.author,message:e.message,sha:e.sha,ghaEventData:e.ghaEventData})},ds=(0,ms.memoize)(ro);o();var gs=m(require("getos")),fs=require("lodash"),L=require("os"),Es=require("util"),so=async()=>{if((0,L.platform)()==="linux")try{let e=await(0,Es.promisify)(gs.default)();return"dist"in e&&"release"in e?[e.dist,e.release].join(" - "):(0,L.release)()}catch{return(0,L.release)()}return(0,L.release)()},no=async()=>{let e=await so();return{osName:(0,L.platform)(),osVersion:e,osCpus:[],osMemory:{free:(0,L.freemem)(),total:(0,L.totalmem)()}}},hs=(0,fs.memoize)(no);o();Q();function Ts(e){return B({method:"POST",url:"runs",data:e}).then(t=>t.data).catch(t=>{if(t.response&&t.response.status===422)return null;throw t})}var oo={parallel:!0,tags:[],testingType:"e2e"};async function Is(e){let t=v();if(!t)return null;let r=await ds(),s=await hs(),{browser:n}=e,i={...{browserName:n.name,browserVersion:n.version},...s},c=us(t.ciBuildId),u={...oo,platform:i,ci:c,commit:r,...e,projectId:t.projectId,recordKey:t.recordKey,ciBuildId:t.ciBuildId,tags:[...t.tag??[],...e.projectTags],removeTitleTags:!!t.removeTitleTags,disableTitleTags:!!t.disableTitleTags,autoCancelAfterFailures:t.cancelAfterFailures,specPattern:"*"};d("Creating run: %o",(0,Rs.mapValues)(u,(p,T)=>T==="recordKey"?"******":p));try{let p=await Ts(u);return d("Run created: %o",p),p}catch{return null}}o();o();o();o();var Cs=e=>{let t=e.split(`
`),r={};for(let s of t){let n=s.match(/\[([^\]]+)\] › ([^:]+):(\d+:\d+) › (.+)/);if(n){let[a,i,c,u,p]=n;r[i]||(r[i]={}),r[i][c]||(r[i][c]=[]),r[i][c].push(p)}}return r};function _s(e,t){return Cs(e)}var ys=m(require("debug")),Ss=(0,ys.default)("pwc-scanner"),Us=async params=>{let{execa}=await eval('import("execa")'),cliParams=["test","--list",...Object.entries(params).filter(([e,t])=>t!==void 0).map(([e,t])=>`${ao(e)}=${t}`),"--reporter=list","--shard=1/1"];Ss("running playwright with the following params: %o",cliParams);let execaResult=await execa("playwright",cliParams,{env:{PWTEST_WATCH:void 0}});return Ss("execa result: %o",execaResult),execaResult.failed?{execaResult,result:null}:{execaResult,result:_s(execaResult.stdout)}},ao=e=>{switch(e){case"project":return"--project";case"grep":return"--grep";case"grepInvert":return"--grep-invert";case"config":return"--config";default:throw new Error("Invalid param")}};P();o();var As=m(require("fs")),N=require("ts-pattern"),Ps=e=>(0,N.match)(e).with({testSuiteFile:N.P.not(N.P.nullish)},t=>t.testSuiteFile).with({testSuiteFile:N.P.string},t=>(0,N.isMatching)({testSuite:N.P.nullish,testSuiteFile:N.P.string},t),({testSuiteFile:t})=>{try{return JSON.parse(As.default.readFileSync(t,"utf-8"))}catch{return null}}).otherwise(()=>null);async function bs(e){try{let t=v(),r=t?Ps(t):null;if(r)return r;let s=lo(e);if(!s)return null;let n={config:e.configFile,grep:xs(s.cliGrep),grepInvert:xs(s.grepInvert)};return Us(n).then(a=>a.result).catch(a=>(S(a),null))}catch(t){S(t)}}function xs(e){debugger;return e?(Array.isArray(e)?e:[e]).join(","):null}function lo(e){let r=Object.getOwnPropertySymbols(e).find(s=>s.toString().match(/configInternalSymbol/));return r?e[r]:(g("Could not extract internal playwright configuration"),null)}var y=d.extend("actor"),Ne=class{config;executionState;warnings=[];errors=[];instanceCreations={};resultCreations={};testResultUploads=[];constructor({suites:t},r){this.config=r,this.executionState=new we(r),t.forEach(s=>{y("Creating project execution state for project: %s",s.title);let n=s.allTests(),a=this.executionState.upsertProjectExecution(s.title).setRun(this.createRun({projectId:s.title,project:s.project(),createRunParams:{specs:(0,W.uniq)(n.map(i=>pe(i,r))),browser:{name:s.title,version:""},tests:n.map(i=>({spec:pe(i,r),title:j(i)})),group:s.title}}));n.forEach(i=>{a.upsertSpecExecution(pe(i,r),X(i)).createTestExecution(Ae(i),i)})})}async createRun(t){let r=await bs(this.config);return y("fullTestSuite: %o",r),Is({...t.createRunParams,projectTags:t.project?.metadata?.pwc?.tags??[]}).then(s=>(s||this.warn("[currents] Could not start recording for project: %s",t.projectId),s?.cancellation&&(J(s.cancellation),ie()),s))}onTestBegin(t){this.startCreatingInstance(t)}onTestEnd(t,r){let s=X(t),n=pe(t,this.config);this.sendTestResult({test:t,result:r,specName:n,projectId:s});let a=this.executionState.getSpecExecution(t),i=this.executionState.getTestExecution(t).setTestCase(t);y("Test end: %o",{title:i.titlePath,attempt:r.retry,retries:t.retries,expectedStatus:t.expectedStatus,actualStatus:r.status,currentsState:i.currentsState,isTestFinished:i.isFinished(),isSpecFinished:a.isFinished()}),a.isFinished()?this.startProcessingResults(a):y("Waiting for more tests to finish before reporting spec...")}sendTestResult(t){let r=v();if(!r){y("Not sending test result - missing config");return}r.enableTestResults&&this.testResultUploads.push(this.executionState.getProjectExecution(t.projectId).run.then(s=>{if(!s){y("Not sending test result - missing run for %s",t.projectId);return}return os({runId:s.runId,groupId:s.groupId,reportedAt:new Date().toISOString(),result:t.result,recordKey:r.recordKey,retry:t.result.retry,status:t.result.status,title:j(t.test),spec:t.specName})}).catch(s=>{y("Error sending test result: %o",s)}))}onStepBegin(t,r,s){}onStepEnd(t,r,s){}warn(...t){this.warnings.push([...t]),g(...t)}async startProcessingResults(t){let r=t.projectId,s=t.specName;if(this.resultCreations[r]||(this.resultCreations[r]={}),this.resultCreations[r][s]){y("Result processing already started: %s %s",r,s);return}y("Starting processing spec result: %o",{projectId:r,spec:s}),this.resultCreations[r][s]=this.createResultForSpec(t)}async createResultForSpec(t){let r=v();if(!r)return;let s=t.projectId,n=t.specName,a=t.getAllTestExecutions(),i=t.isFailed(),c=await this.instanceCreations[s][n];if(!c?.instanceId){this.warn("[currents] Missing reporting instructions for file, skipping: [%s] \u203A %s",s,n);return}if(c?.claimedCount>1){this.warn('[currents] Results already reported for build "%s" [%s] \u203A %s',r.ciBuildId,s,n);return}return uo({instanceId:c.instanceId,testCases:a.map(u=>u.testCase),config:this.config},{status:i?"failed":"passed"})}startCreatingInstance(t){let r=X(t),s=pe(t,this.config);if(this.instanceCreations[r]||(this.instanceCreations[r]={}),this.instanceCreations[r][s]){y("Instance creation already started: %s %s",r,s);return}y("Starting instance creation: %o",{projectId:r,spec:s}),this.instanceCreations[r][s]=this.createInstanceForSpec({projectId:r,specName:s,worker:it(t)})}async createInstanceForSpec({projectId:t,specName:r,worker:s}){y("Getting run for projectId",{projectId:t});let n=await this.executionState.getProjectExecution(t).run;if(!n)return;let{runId:a,groupId:i,machineId:c}=n,{instanceId:u,claimedCount:p,...T}=await hr({runId:a,groupId:i,machineId:c,spec:r,worker:s});return y("Create instance response: %s %s %o",s,t,r,u,p),{instanceId:u,claimedCount:p,spec:r}}async awaitAllResults(){let t=Object.values(this.resultCreations).flatMap(r=>Object.values(r));return y("Awaiting for completion of reporting tasks..."),Promise.allSettled([...t,...this.testResultUploads])}async getRunURL(){let t=this.executionState.getAllProjectExecutions();if(t.length)return(await t[0].run)?.runUrl}async getRunId(){let t=this.executionState.getAllProjectExecutions();if(t.length)return(await t[0].run)?.runId}getSpecExecutionsWithNoResults(){let t=Object.values(this.resultCreations).flatMap(n=>Object.keys(n)),r=new Set(t),s=[];return this.executionState.getAllSpecExecutions().forEach(n=>{r.has(n.specName)||s.push(n)}),s}reportSpecsWithNoResults(){function t(r){return{status:"skipped",workerIndex:-1,parallelIndex:0,duration:0,startTime:new Date,stdout:["Playwright could not run this test because of maximum allowed failures, or SIGINT was received."],stderr:["Playwright could not run this test because of maximum allowed failures, or SIGINT was received."],attachments:[],steps:[],error:{message:"Playwright did not run this test",stack:""},errors:[],retry:r}}this.getSpecExecutionsWithNoResults().forEach(r=>{let s=r.getAllTestExecutions().filter(a=>!a.isFinished());if(!s.length)return;let n=s.length===1?"it":"them";g(`Playwright did not run ${(0,Os.default)("test",s.length,!0)}, reporting ${n} as ${Ct("skipped")}:`),s.forEach(a=>{M(C(`- ${a.titlePath}`));let i=(0,W.extend)(a.testCase),c=a.testCase.retries+1-i.results.length;Array.from({length:c}).forEach(u=>{i.results.push(t(i.results.length+1))}),this.onTestBegin(i),this.onTestEnd(i,(0,W.last)(i.results)??t(0))}),K()})}};function pe(e,t){return Ue(e.location,t.rootDir)}async function uo({instanceId:e,testCases:t,config:r},s){let n=t.map((p,T)=>(0,W.extend)(p,{clientId:co(T)})),a=t.flatMap(p=>p.results).flatMap(p=>[...p.stdout,p.stderr]).filter(p=>typeof p=="string"),{failures:i,summaryMessage:c}=rs(t,r,s),u=a.join(`
`)+i.join(`
`)+c;await Promise.allSettled([Qr({instanceId:e,testCases:n,stdout:[u,...Rt()].join(`
`)})]),ie()}function co(e){return`r${e}`}var dt=d.extend("default"),Ls=d.extend("step"),me=class{errors=[];_testActor=null;get testActor(){if(!this._testActor)throw new Error("@currents/playwright panic: Test actor not initialized");return this._testActor}constructor(t){try{fr(t),ir({source:"core",mode:v()?.debug??!1})}catch(r){(0,Be.match)(r).with(Be.P.instanceOf(z),()=>{process.exit(1)}).otherwise(s=>{throw S("Unexpected error",s),new Error("Unexpected error")})}}printsToStdio(){return!1}onBegin(t,r){dt("Beginning tests execution: %o",r.allTests().map(s=>s.titlePath())),qt(t.version),Nt(),this._testActor=new Ne(r,t)}onError(t){S("Global error reported by test runner: %o",t),this.errors.push(t)}onStepBegin(t,r,s){Ls("[step  in] %s :: %s",t.titlePath().filter(Boolean).join(" > "),s.title),this.testActor.onStepEnd(t,r,s)}onStepEnd(t,r,s){Ls("[step out] %s :: %s [%dms] [%s]",t.titlePath().filter(Boolean).join(" > "),s.title,s.duration,s.error?.message??"ok"),this.testActor.onStepEnd(t,r,s)}onTestBegin(t){dt("Test begin: %s",t.titlePath().filter(Boolean).join(" > ")),this.testActor.onTestBegin(t)}onTestEnd(t,r){dt("Test end: %s",t.titlePath().filter(Boolean).join(" > ")),this.testActor.onTestEnd(t,r)}async onEnd(){try{K();let t=this.testActor.executionState.getAllSpecExecutions();if(!t.length)return g("No tests detected, skipping upload"),K(),{status:"passed"};po(this.errors).length>0&&(g("Processing errors:"),this.errors.forEach(n=>console.log(n.message))),this.testActor.warnings.length&&(g("Processing errors:"),this.testActor.warnings.forEach(n=>console.log(...n))),be.size>0&&(g("Upload warnings:"),be.forEach(n=>console.log(n)));let r=t.some(n=>n.isFailed())?"failed":"passed";this.testActor.reportSpecsWithNoResults(),fe("Uploading results to Currents.dev..."),await this.testActor.awaitAllResults();let s=await this.testActor.getRunURL();return s?(fe("Cloud Run Finished: %s",s),process.env.CURRENTS_RUN_URL_FILE&&(console.log("Writing run url to file",process.env.CURRENTS_RUN_URL_FILE),ws.default.writeFileSync(process.env.CURRENTS_RUN_URL_FILE,s))):fe("Cloud Run Finished"),K(),await ar({runId:await this.testActor.getRunId()}),process.env._CURRENTS_E2E_TESTS&&await new Promise(n=>setTimeout(n,1e3)),{status:r}}catch(t){return console.error(t),{status:"failed"}}finally{Bt()}}};function po(e){return e.map(t=>({spec:mo(t),error:`${t.message}
 ${t.stack}`||""}))}function mo(e){if(!e.stack)return"";let s=e.stack.split(" ").filter(n=>n.includes(".ts:")||n.endsWith(".js:"))[0];return s?s.split("/")?.pop()?.split(":")[0]??"":""}var go=e=>["@currents/playwright",e],fo=me;0&&(module.exports={currentsReporter});
/*! For license information please see index.js.LEGAL.txt */
//# sourceMappingURL=index.js.map